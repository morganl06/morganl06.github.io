---
title: "Diabetes simulation study"
---

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(readr)
global_mortality <- read_csv("global_mortality.csv")
view(global_mortality)
```

This dataset presents the mortality rate for different diseases, per year (from 1990 to 2016) and per country. We are exploring the specific average rate of mortality from diabetes in the United States and in France across all years. The dataset I analyzed comes from the Tidy Tuesday database and is available at the following link: <https://github.com/rfordatascience/tidytuesday/tree/main/data/2018/2018-04-16>

The original data comes from an article entitled, "Causes of death" and published in the Our World in Data magazine by Saloni Dattani, Fiona Spooner, Hannah Ritchie and Max Roser at the following link: Dattani, S., Spooner, F., Ritchie, H., & Roser, M. (2023). Causes of Death. *Our World in Data*. <https://ourworldindata.org/causes-of-death>

In this simulation study, we will explore whether France and the United States have the same average diabetes mortality rate. We will first calculate the observed difference in mean diabetes mortality between the two countries across all available years (1990-2016). To test whether the difference we observe could have been a result of random distribution, we will run a permutation test shuffling the diabetes mortality percentage rate per country 1000 times, to create a null distribution. By treating the observed years as a sample, we can use a permutation test to assess whether the observed difference in average mortality is larger than we would expect from random variation in yearly mortality. This allows us to generalize conclusions beyond the years in the dataset.

The research question we are answering is the following: Do France and the United States differ in their underlying diabetes mortality processes, such that the observed differences in yearly diabetes mortality are larger than what we would expect due to random chance?

The null hypothesis (Ho): The underlying process generating the diabetes mortality rate is the same in France and the US. Any observed difference in yearly mortality rates is due to random variation across years.

The alternative hypothesis (Ha): The underlying process differs between the two countries, leading to different average diabetes mortality rates.

```{r, warning=FALSE, message=FALSE}

library(dplyr)
library(ggplot2)
library(readr)

# Filter data for France and US, select relevant columns
mortality_filtered <- global_mortality |>
  filter(country %in% c("France", "United States")) |>
  select(country, year, `Diabetes (%)`) |>
  rename(diabetes_pct = `Diabetes (%)`)  # rename column for easier handling
```

```{r, warning=FALSE, message=FALSE}
#| fig-alt: "Bar chart showing the average diabetes mortality (%) across all years for France and the United States."

# Compute average diabetes mortality per country
mortality_avg <- mortality_filtered |>
  group_by(country) |>
  summarize(avg_diabetes = mean(diabetes_pct))

# Plot the averages for visual comparison
ggplot(mortality_avg, aes(x = country, y = avg_diabetes, fill = country)) +
  geom_col(show.legend = FALSE) +
  labs(
    title = "Average Diabetes Mortality (%) Across All Years",
    x = "Country",
    y = "Average Diabetes Mortality (%)"
  ) +
  theme_minimal()
```

The main variable of interest is the percentage of diabetes mortality rate. While the dataset doesn't include a clear statement of what this variable represents, we can infer based on the name of the variable and the dataset itself, that it represents the percentage of deaths in a given year that were attributed to diabetes among all deaths.

We observe a difference in average mortality rate between the two countries, so now we are going to test if this is a result of the random distribution model, by establishing a null distribution. Instead of comparing only the two countries' averages, we will repeatedly shuffle the yearly diabetes mortality percentages between the two countries, recompute the average mortality for each country, and record the difference. By repeating this process 1000 times, we can see how large the difference would be between the two countries if we were following the random chance model.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#| fig-alt: "Histogram of the null distribution of differences in mean diabetes mortality between France and the US, based on 1000 permutations. The observed difference is marked with a red dashed line."

library(purrr)

# Compute observed difference in average diabetes mortality
obs_diff <- diff(mortality_avg$avg_diabetes)

# Function to perform one permutation
perm_data <- function(rep, data) {
  data |>
    select(country, diabetes_pct) |>
    mutate(diabetes_perm = sample(diabetes_pct, replace = FALSE)) |>
    group_by(country) |>
    summarize(
      perm_ave = mean(diabetes_perm)
    ) |>
    summarize(
      perm_diff = diff(perm_ave),  # difference between France and US
      rep = rep
    )
}

set.seed(47)
# Run 1000 permutations to create null distribution
perm_stats <- map(1:1000, perm_data, data = mortality_filtered) |>
  list_rbind()

# Plot histogram of permutation differences with observed difference marked
ggplot(perm_stats, aes(x = perm_diff)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "pink", color = "black", alpha = 0.5) +
  geom_vline(aes(xintercept = obs_diff), color = "red", linetype = "dashed", size = 1.2) +
  labs(
    title = "Null Distribution of Difference in Diabetes Mortality (%)",
    subtitle = "France vs United States (All Years)",
    x = "Difference in Mean Mortality (France versus U.S.)",
    y = "Density"
  ) +
  theme_minimal()
```

This permutation test assesses whether the observed difference in average diabetes mortality between France and the United States is larger than would be expected if the underlying mortality process were the same in both countries. By shuffling the yearly mortality percentages 1,000 times, we generated a null distribution representing the differences we might see due to random yearly fluctuations. The observed difference falls far outside this null distribution (p ≈ 0), providing strong evidence that the underlying process generating diabetes mortality differs between France and the US, not just in the years 1990–2016 but as a general pattern. We can therefore reject the null hypothesis.
